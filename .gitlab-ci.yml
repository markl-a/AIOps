# GitLab CI/CD with AIOps Integration

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

stages:
  - setup
  - analysis
  - test
  - review
  - deploy

# Setup stage
install_aiops:
  stage: setup
  image: python:3.10
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -e .
  artifacts:
    paths:
      - venv/
    expire_in: 1 hour

# AI Code Review
ai_code_review:
  stage: review
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - |
      # Review changed files
      git diff --name-only $CI_MERGE_REQUEST_DIFF_BASE_SHA...$CI_COMMIT_SHA | grep '\.py$' > changed_files.txt || echo "No Python files"

      if [ -s changed_files.txt ]; then
        while IFS= read -r file; do
          echo "Reviewing $file..."
          aiops review "$file" --language python > "${file}.review.txt" || true
        done < changed_files.txt

        # Combine reviews
        cat *.review.txt > code_review_report.txt 2>/dev/null || echo "No reviews generated"
      fi
  artifacts:
    reports:
      codequality: code_review_report.txt
    paths:
      - "*.review.txt"
    expire_in: 30 days
  only:
    - merge_requests

# Security Scanning
ai_security_scan:
  stage: analysis
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - echo "Running AI security scan..."
    - |
      # Scan Python files for security issues
      find . -name "*.py" -not -path "./venv/*" | while read file; do
        aiops security-scan "$file" --output "$file.security.json" || true
      done
  artifacts:
    reports:
      sast: "**/*.security.json"
    expire_in: 30 days
  allow_failure: true

# Test Generation
ai_test_generation:
  stage: test
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - |
      # Generate tests for new files without tests
      find . -name "*.py" -not -path "./venv/*" -not -path "./tests/*" | while read file; do
        test_file="tests/test_$(basename $file)"
        if [ ! -f "$test_file" ]; then
          echo "Generating tests for $file..."
          aiops generate-tests "$file" --output "$test_file" || true
        fi
      done
  artifacts:
    paths:
      - tests/
    expire_in: 7 days
  when: manual

# Log Analysis (for failed pipelines)
ai_log_analysis:
  stage: analysis
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - |
      # Analyze previous pipeline logs if this is a retry
      if [ -n "$CI_PIPELINE_ID" ]; then
        echo "Analyzing pipeline logs..."
        # In a real scenario, fetch logs from previous pipeline
        aiops analyze-logs ci_pipeline.log > log_analysis.md || echo "No logs to analyze"
      fi
  artifacts:
    paths:
      - log_analysis.md
    expire_in: 7 days
  when: on_failure

# Performance Analysis
ai_performance_check:
  stage: analysis
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - |
      # Analyze performance-critical files
      find . -name "*.py" -not -path "./venv/*" | while read file; do
        if grep -q "performance\|optimization\|cache" "$file"; then
          echo "Analyzing performance of $file..."
          aiops analyze-performance "$file" > "$file.perf.txt" || true
        fi
      done
  artifacts:
    paths:
      - "**/*.perf.txt"
    expire_in: 30 days
  allow_failure: true

# Pipeline Optimization (weekly)
optimize_pipeline:
  stage: analysis
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - |
      echo "Analyzing CI/CD pipeline for optimization..."
      aiops optimize-pipeline .gitlab-ci.yml > pipeline_optimization.md
  artifacts:
    paths:
      - pipeline_optimization.md
    expire_in: 30 days
  only:
    - schedules
  when: manual

# Code Quality Analysis
ai_quality_check:
  stage: analysis
  image: python:3.10
  dependencies:
    - install_aiops
  script:
    - source venv/bin/activate
    - |
      # Quality check for main source files
      find ./aiops -name "*.py" | while read file; do
        echo "Quality check: $file..."
        aiops quality-check "$file" > "$file.quality.json" || true
      done

      # Generate summary report
      cat **/*.quality.json > quality_report.json 2>/dev/null || echo "{}" > quality_report.json
  artifacts:
    reports:
      metrics: quality_report.json
    expire_in: 30 days
  allow_failure: true
